# ISMS Project

This is the documentation for the ISMS project, built upon five smaller projects:

- `mkdocs_site`
- `md_to_yml.py`
- `api_endpoint`
- `yaml_docx_filler`
- `risk_quant_calculator`

The ISMS project is a collection of tools that are used to provide a framework for creating cybersecurity documentation for an ISMS (Information Security Management System), calculating risks quantitatively, and serving the documentation as a website and an API endpoint. The project is built upon Python and Docker, and is designed to be modular and extensible.

## Microservices

### mkdocs_site

This project is built upon a static site generator called `mkdocs`. It is used to generate the documentation for the ISMS project using markdown files, a file format that is easy to read and write. `mkdocs` is extended with the `mkdocs-material` theme, which provides a clean and modern look for the documentation.

### md_to_yml.py

This is a Python script that converts markdown files to yaml files. It is used to convert the markdown files in the `mkdocs_site` project to yaml files, which are used by the `api_endpoint` project to provide RESTful API responses, as well as for the `yaml_docx_filler` project to fill in docx templates. This is supported by `conversion_list.json`, which acts as a configuration file for the script.

### api_endpoint

This project is built upon a RESTful API framework called `FastAPI`. It is used to provide an endpoint for the ISMS project to interact with the `yaml_docx_filler` project. The endpoint allows programmatic access to the data in the yaml files, providing a way to retrieve the data and potentially being extended towards updating or deleting data.

### yaml_docx_filler

This project is built upon a Python library called `docxtpl`. It is used to fill in docx templates with data from yaml files. It is used to provide a service for the ISMS project to fill in docx templates with data from yaml files, standardizing the process for generating documents.

### risk_quant_calculator

This project is built upon the implementation of my [Quantitative Risk Calculation Tool](https://github.com/NicholasChua/risk_quant_calculator). It is used to provide risk calculations for cybersecurity use cases, such as before-after control implementation, control order optimization, and vendor comparisons. For more information, please see the linked repository.

## Requirements

Note: The following requirements are for all projects here. Based on the my knowledge on the requirements, Python 3.12 or higher is required. This project was tested on Python 3.12 on a Windows 11 machine.

- Python 3.12 or higher
- Generic XDR Server (Redacted in this repository)

## Installation

1. Clone the repository

```bash
git clone https://github.com/NicholasChua/isms_project.git
```

2. Create a virtual environment and install the requirements

```bash
pip install -r requirements.txt
```

3. Fill the .env file with the necessary environment variables. See [.env File Section](#env-file) for more information.

```plaintext
ENVIRONMENT=production
XDR_URL=<XDR URL>
XDR_API_KEY=<XDR API Key>
VALID_DOCSITE_API_TOKEN=<Self-defined API Password>
```

4. Run the container

```bash
docker-compose up -d
```

## File and Folder Structure

```plaintext
.
├───.venv
├───.gitignore
├───README.md
├───requirements.txt
├───LICENSE
├───.foam
│   └───templates
│        └───doc-template.md
├───common
│   ├───__init__.py
│   ├───auth_utils.py
│   ├───common_stats.py
│   ├───endpoint.py
│   ├───helper_functions.py
│   ├───md_to_yml.py
│   ├───risk_simulator.py
│   ├───rqmc_sobol_sensitivity_analysis.py
│   ├───rqmc_vendor_assessment.py
│   ├───xdr_audit.py
│   └───yaml_docx_filler.py
├───docs
│   ├───ExampleDoc.md
│   ├───index.md
│   └───<documents>.md (Your own Markdown documents)
├───routes
│   ├───user_document.py
│   ├───user_root.py
│   ├───user_risk_calc.py
│   └───user_audit.py
├───site (Generated by Mkdocs if ran locally)
├───temp_yml
│   └───README.md
├───templates
│   └───template_general.docx
├───yml
│   ├───README.md
│   └───<documents>.yml (Generated by md_to_yml.py)
├───docx_docs
│   ├───README.md
│   └───<documents>.docx (Generated by yaml_docx_filler.py)
├───.env (Create this)
├───conversion_list.json
├───mkdocs.yml
├───main.py
├───.dockerignore
├───Dockerfile
└───compose.yml
```

## Usage

### .env File

**Warning**: Do not share, upload, commit, or otherwise expose your API keys to the public. This can lead to unauthorized access and usage of your API keys. The .env file is used to store your API keys in a secure manner, and has been added to the .gitignore file to prevent accidental exposure.

1. Create a .env file in the root directory of the project with the following format:

The .env file should contain the following:

```plaintext
ENVIRONMENT=production
XDR_URL=<XDR URL>
XDR_API_KEY=<XDR API Key>
VALID_DOCSITE_API_TOKEN=<Self-defined API Password>
```

1. **Optional: Not functional in this repository.** Replace `<XDR URL>` with your XDR URL. This is used to connect to the Generic XDR server to retrieve information about the XDR environment.

2. **Optional: Not functional in this repository.** Replace `<XDR API Key>` with your XDR's API Key. This is used to authenticate requests to the Generic XDR server. This key should be generated in the XDR console and should have the necessary permissions to access the required information.

3. The `<Self-defined API Password>` is a token that is used to authenticate requests to the Deep Security audit endpoints. This is to prevent unauthorized access to the audit server. The token can be any string, but it is recommended to use a long, random string. This token is used in the X-API-Key header of the request to the audit server. This token should be set by the user (IT Admin) and should be kept secure.

4. Ensure that the .env file is in the root directory of the project.

### Docker

The project is available as a Docker container. It is able to convert markdown files (already included in this repository) to yaml files, fill in docx templates with data from yaml files, and serve both the documentation site and the API endpoint.

Documentation site: [http://localhost:8000](http://localhost:8000)
API Endpoint: [http://localhost:8080/docs](http://localhost:8080/docs)

```bash
docker-compose up -d
```

To stop the container:

```bash
docker-compose down
```

### Local Development

To run the project locally, you can run the following command:

```bash
python main.py
```

Additionally, the `.env` file's `ENVIRONMENT` variable should be set to `development`. This causes the servers to listen locally only, and not expose the API endpoints to the public.

The [Docker](#docker) method is recommended over the local development method, especially for production environments.

### Document Creation Workflow

The project assumes you have [Foam](https://foambubble.github.io/foam) installed. The documentation is written in markdown files, which are then converted to yaml files using `md_to_yml.py`. The yaml files are then used to fill in docx templates using `yaml_docx_filler.py`.

The document template is stored in the `.foam/templates` folder, under `doc-template.md`. The docx templates are stored in the `templates` folder. The filled docx documents are stored in the `docx_docs` folder.

1. In VSCode, use `> Foam: Create New Note from Template` to create a new document. Give it a title and save it in the `docs` folder.

2. Write the content of the document in markdown format, according to the template.

3. Once the document is ready, update the `conversion_list.json` file with the new document. Place the document title without the `.md` extension in the `yml_convert_without_issues` list and the `docx_standard_convert` list.

4. Start the Docker container to convert the markdown file to yaml and fill in the docx template. The `compose.yml` file has already been configured to mount the necessary volumes, thus allowing the files to be accessible by your local machine despite being generated in the container.

5. The filled docx document will be available in the `docx_docs` folder. The intermediate yaml file will be available in the `yml` folder.

6. You may check the documentation site (http://localhost:8000) and the API endpoint (http://localhost:8080/docs) to see that the document has been added and is served correctly.

Extreme deviations from the template, such as use of multiple tables, images, or other complex formatting, may not be supported by the general template. In such cases, a custom template may be required to be created.

### Documentation Site

The documentation site is built upon `mkdocs` and provides a way to view the documentation in a clean and modern format. The documentation site is available at [http://localhost:8000](http://localhost:8000).

The documentation site contains an index page and a list of documents. Each document has its own page, and has been created using the [Document Creation Workflow](#document-creation-workflow).

### API Endpoint

The API endpoint is built upon `FastAPI` and provides a way to programmatically access the documentation through RESTful API calls. The API endpoint is available at [http://localhost:8080/docs](http://localhost:8080/docs).

The API endpoint provides the following routes:
- `/v1/documents`: Document-serving capabilities.
  - `v1/documents`: Get a list of documents.
  - `v1/documents/{document}`: Get information about a specific document, based on the document title.
  - `v1/documents/{document}/sections`: Get the sections of a specific document, based on the document title.
  - `v1/documents/{document}/sections/{section}`: Retrieve only a specific section of a specific document.
- `/v1/audit`: Audit capabilities for Generic XDR. Requires an API key. Not functional in this repository, here for demonstration purposes only.
  - `v1/audit/xdr`: Get information about auditing capabilities for Deep Security.
  - `v1/audit/xdr/generic-route`: Generic route for auditing capabilities for Deep Security.
- `/v1/risk`
  - `v1/risk/before-after`: Perform a before-and-after risk analysis, using a choice of Monte Carlo or Markov Chain Monte Carlo simulations.
  - `v1/risk/rqmc-sequence-analysis`: Given known asset values but other uncertain values, and a number of controls to be implemented at 1 a year, determine the optimal sequence of controls to implement.
  - `v1/risk/rqmc-vendor-assessment`: Given a list of vendors, known costs, but uncertain effectiveness and other values, determine which vendor to choose.

#### Risk Calculations

##### Before-After Risk Analysis

The before-after risk analysis endpoint allows you to perform a before-and-after risk analysis, using a choice of Monte Carlo or Markov Chain Monte Carlo simulations. This endpoint requires the following parameters:

- `asset_value`: The value of the asset. Must be a float greater than 0.
- `exposure_factor`: The potential percentage of loss to a specific asset if a particular threat is realized. Must be a float between 0 and 1.
- `annual_rate_of_occurrence`: The rate of occurrence of a threat, normalized to 1 year. Must be a float greater than 0.
- `percentage_reduction`: The percentage reduction in risk due to the implementation of a control. Must be a float between 1 and 99.
- `cost_of_control`: The cost of implementing the control. Must be a float greater than 0.
- `simulation_method`: Must be 0 for Monte Carlo simulation or 1 for Markov Chain Monte Carlo simulation.

An example of a CURL request to the endpoint is as follows:

```bash
curl --request GET \
  --url 'http://localhost:8080/v1/risk/before-after?asset_value=10000&exposure_factor=0.5&annual_rate_of_occurrence=2.0&percentage_reduction=50&cost_of_control=10000&simulation_method=1' \
  --header 'accept: application/json'
```

Due to complex calculations, allow at least 10 seconds for the response to be generated. More time may be required for Markov Chain Monte Carlo simulations as compared to Monte Carlo simulations.

##### RQMC Sequence Analysis

The RQMC sequence analysis endpoint allows you to determine the optimal sequence of controls to implement, given known asset values and control reductions but uncertain exposure factor, annual rate of occurrence, and compounding costs. This endpoint requires the following parameters:

- `asset_value`: The value of the asset. Must be a float greater than 0.
- `exposure_factor_min`: The lower bound of the exposure factor range. Must be a float between 0 and 1.
- `exposure_factor_max`: The upper bound of the exposure factor range. Must be a float between 0 and 1.
- `annual_rate_of_occurrence_min`: The lower bound of the annual rate of occurrence range. Must be a float greater than 0.
- `annual_rate_of_occurrence_max`: The upper bound of the annual rate of occurrence range. Must be a float greater than 0.
- `cost_adjustment_min`: The lower bound of a yearly cost adjustment range, to be applied to all controls in a compounding manner. Must be a float between -1 and 1.
- `cost_adjustment_max`: The upper bound of a yearly cost adjustment range, to be applied to all controls in a compounding manner. Must be a float between -1 and 1.
- `control_reductions`: A list of control reductions, in the order they are to be implemented. Must be a list of floats between 0 and 0.99.
- `control_costs`: A list of control costs, in the order they are to be implemented. Must be a list of floats greater than 0.

An example of a CURL request to the endpoint is as follows:

```bash
curl --request GET \
  --url 'http://localhost:8080/v1/risk/rqmc-sequence-analysis?asset_value=500000&exposure_factor_min=0.4&exposure_factor_max=0.6&annual_rate_of_occurrence_min=1.5&annual_rate_of_occurrence_max=2.5&cost_adjustment_min=0&cost_adjustment_max=0.2&control_reductions=0.2&control_reductions=0.35&control_reductions=0.3&control_reductions=0.45&control_costs=10000&control_costs=30000&control_costs=20000&control_costs=35000' \
  --header 'accept: application/json'
```

Due to complex calculations, allow at least 20 seconds for the response to be generated. Time required may increase exponentially with the number of controls to be assessed.

##### RQMC Vendor Assessment

The RQMC vendor assessment endpoint allows you to determine which vendor to choose, given a list of vendors, known costs, but uncertain exposure factor, annual rate of occurrence, and control effectiveness. This endpoint requires the following parameters:

- `asset_value`: The value of the asset. Must be a float greater than 0.
- `exposure_factor_min`: The lower bound of the exposure factor range. Must be a float between 0 and 1.
- `exposure_factor_max`: The upper bound of the exposure factor range. Must be a float between 0 and 1.
- `annual_rate_of_occurrence_min`: The lower bound of the annual rate of occurrence range. Must be a float greater than 0.
- `annual_rate_of_occurrence_max`: The upper bound of the annual rate of occurrence range. Must be a float greater than 0.
- `control_costs`: A list of control costs, in the order of controls to be assessed. Must be a list of floats greater than 0.
- `control_effectiveness_mins`: A list of lower bounds of control effectiveness, in the order of controls to be assessed. Must be a list of floats between 0 and 1.
- `control_effectiveness_maxs`: A list of upper bounds of control effectiveness, in the order of controls to be assessed. Must be a list of floats between 0 and 1.

An example of a CURL request to the endpoint is as follows:

```bash
curl --request GET \
  --url 'http://localhost:8080/v1/risk/rqmc-vendor-assessment?asset_value=500000&exposure_factor_min=0.4&exposure_factor_max=0.6&annual_rate_of_occurrence_min=1.5&annual_rate_of_occurrence_max=2.5&control_costs=10000&control_costs=30000&control_costs=20000&control_costs=35000&control_reduction_mins=0.2&control_reduction_mins=0.35&control_reduction_mins=0.3&control_reduction_mins=0.45&control_reduction_maxs=0.3&control_reduction_maxs=0.65&control_reduction_maxs=0.4&control_reduction_maxs=0.7' \
  --header 'accept: application/json'
```

Due to complex calculations, allow at least 15 seconds for the response to be generated. Time required may increase exponentially with the number of controls to be assessed.
